<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap");
      * {
        font-family: "Roboto Slab", serif;
        color: bisque;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: darkslategray;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
      }
      h1 {
        margin: 2rem;
        text-align: center;
      }
      .d-flex {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }
      .align-center {
        align-items: center;
      }
      .wrap {
        flex-wrap: wrap;
      }
      .input-wrapper {
        position: relative;
        width: 50%;
        height: 4rem;
      }
      input.search {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 2rem 1rem;
        font-size: 1.5rem;
        border: 2px solid #ff8c00;
        border-radius: 0.2rem;
        background-color: #ff8c0022;
        color: bisque;
      }
      input.search:disabled {
        color: gray;
      }
      /* progress */
      #searchProgress {
        position: absolute;
        pointer-events: none;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ff8c0055;
        transform-origin: left;
        transform: scaleX(0);
        transition: transform 0.2s, opacity 1s;
      }
      button,
      .btn-link {
        margin: 1rem;
        padding: 1rem;
        background-color: #ff8c0022;
        border: 2px solid #ff8c00;
        border-radius: 0.2rem;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.1s;
      }
      button:hover,
      .btn-link:hover {
        background-color: #ff8c00;
      }
      button#pickFiles {
        display: block;
        margin: auto;
      }
      li {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
      }
      li:not(:last-child) {
        border-bottom: 1px solid #ff8c00;
      }
      #uploadStatusContainer {
        position: relative;
        background-color: #ff8c0022;
        border: 2px solid #ff8c00;
        margin: 1rem;
        height: 4rem;
        flex: 1 1 100%;
        border-radius: 0.2rem;
        overflow: hidden;
      }
      .upload-status {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ff8c00;
        transform-origin: left;
        transform: scaleX(0);
        padding: 1rem;
        transition: transform 0.2s;
      }
      .occurences {
        max-height: 400px;
        overflow: auto;
        padding: 1rem;
        margin: 1rem;
      }
      /* custom scroll */
      .occurences::-webkit-scrollbar {
        width: 12px;
      }
      .occurences::-webkit-scrollbar-track {
        background: #ff8c0022;
      }
      .occurences::-webkit-scrollbar-thumb {
        background-color: #ff8c00;
        border-radius: 6px;
        border: 3px solid #ff8c0022;
      }
      .occurences::-webkit-scrollbar-thumb:hover {
        background-color: #ff8c00;
      }
    </style>
  </head>
  <body id="dropZone" ondragover="allowDrag(event)" ondrop="handleDrop(event)">
    <h1>MyGoogle Search</h1>
    <div class="d-flex align-center">
      <div class="input-wrapper">
        <input class="search" type="text" onkeyup="search(event)" />
        <div id="searchProgress"></div>
      </div>
      <button id="searchBtn" onclick="search(event)">
        <span class="material-symbols-outlined"> search </span>
      </button>
    </div>
    <div>
      <h1 id="searchResults"></h1>
      <ul id="searchResultsList"></ul>
    </div>
    <div class="d-flex">
      <div>
        <h1>Arquivos Inseridos</h1>
        <ul id="filePathList"></ul>
      </div>
      <div>
        <h1>Arraste arquivos .txt para incluir ou</h1>
        <input
          type="file"
          id="fileInput"
          accept=".txt"
          required
          multiple
          onchange="handleFiles(this.files)"
          hidden
        />
        <button
          id="pickFiles"
          onclick="document.querySelector('#fileInput').click()"
        >
          Selecionar de arquivos locais
        </button>
        <ul id="fileList"></ul>
      </div>
    </div>
    <script
      src="https://cdn.socket.io/4.7.5/socket.io.min.js"
      integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
      crossorigin="anonymous"
    ></script>
    <script>
      const API_URL = "http://127.0.0.1:5000";
      const filesList = [];
      const filePathList = [];
      const results = [];

      window.onload = () => {
        getFiles();
      };

      const input = document.querySelector(".search");
      const searchResults = document.getElementById("searchResults");
      const searchResultsList = document.getElementById("searchResultsList");
      let start = 0;
      let end = 0;
      const socket = io(API_URL, {
        autoConnect: false,
      });

      socket.on("connect", function () {
        console.log("Connected to server");
        start = performance.now();
      });

      socket.on("close_connection", function (data) {
        document.querySelector("#searchProgress").style.opacity = 0;
        input.removeAttribute("disabled");
        end = performance.now();
        document.getElementById("searchResults").innerHTML += " em " + (end - start).toFixed(2) + "ms";
        if (results.length === 0) {
          searchResults.innerHTML = "Nenhum resultado encontrado em " + (end - start).toFixed(2) + "ms";
          document.getElementById("searchResultsList").innerHTML = "";
          return;
        }
        socket.disconnect();
      });
      socket.on("result", function (data) {
        results.push(data);
        results.sort((a, b) => b.occurences.length - a.occurences.length);
        updateResults();
      });
      socket.on("occurence", function (data) {
        results
          .find((result) => result.fileName === data.fileName)
          .occurences.push(data.occurence);
        results.sort((a, b) => b.occurences.length - a.occurences.length);
        updateResults();
      });

      socket.on("search_progress", function (data) {
        const searchBar = document.querySelector("#searchProgress");
        searchBar.style.transform = `scaleX(${
          data.searched / data.totalBytes
        })`;
      });

      function getFiles() {
        fetch(`${API_URL}/list`)
          .then((response) => response.json())
          .then((data) => {
            filePathList.length = 0;
            filePathList.push(...data);
            updateFilePathList();
          });
      }
      function updateFilePathList() {
        const fileListElement = document.getElementById("filePathList");
        fileListElement.innerHTML = "";
        filePathList.forEach((file, index) => {
          const fileElement = document.createElement("li");
          fileElement.innerHTML = `<h5>File: ${file.fileName}</h5>
          <div class="d-flex">
            <button onclick="deleteFile(${index})"><span class="material-symbols-outlined">delete</span></button>
            <a class="btn-link" href="${API_URL}/${file.filePath}" target="_blank"><span class="material-symbols-outlined">download</span></a>
          </div>`;
          fileListElement.appendChild(fileElement);
        });
      }
      function search(event) {
        if (event.key === "Enter" || event.type === "click") {
          const searchValue = input.value;
          if (searchValue.length === 0) {
            searchResults.innerHTML = "";
            searchResultsList.innerHTML = "";
            return;
          }

          socket.connect();
          socket.emit("search", searchValue);
          results.splice(0, results.length);
          updateResults();
          document.querySelector("#searchProgress").style.opacity = 1;
          input.setAttribute("disabled", true);
        }
      }
      function updateResults() {
        document.getElementById("searchResults").innerHTML = "Resultados";
        const searchResultsList = document.getElementById("searchResultsList");
        searchResultsList.innerHTML = "";

        results.forEach((result) => {
          const resultElement = document.createElement("li");
          resultElement.innerHTML = `<h5>${result.fileName}</h5>
                <p>Encontrado ${result.occurences.length} vezes</p>
                <a class="btn-link" href="${API_URL}/${result.filePath}" target="_blank"><span class="material-symbols-outlined">download</span></a>`;
          const occurences = document.createElement("ol");
          occurences.classList.add("occurences");
          result.occurences.forEach((occurence, index, array) => {
            if (index > 19) return;
            const occurenceElement = document.createElement("li");
            if (index === 19) {
              occurences.innerHTML +=
                "<p>Mostrando 20 de " + array.length + "</p>";
              occurences.appendChild(occurenceElement);
              return;
            }
            occurenceElement.innerHTML =
              "<p>" +
              (index + 1) +
              " - " +
              " No Byte " +
              occurence.start +
              " - " +
              occurence.context +
              "</p>";
            occurences.appendChild(occurenceElement);
          });
          searchResultsList.appendChild(resultElement);
          searchResultsList.appendChild(occurences);
        });
      }
      function allowDrag(event) {
        event.preventDefault();
      }

      function handleDrop(event) {
        event.preventDefault();
        const files = event.dataTransfer.files;
        addFilesToList(files);
      }

      function handleFiles(files) {
        addFilesToList(files);
      }

      function addFilesToList(files) {
        for (const file of files) {
          filesList.push(file); // Add new files to the list
        }
        updateFileList();
      }
      function removeFile(index) {
        filesList.splice(index, 1);
        updateFileList();
      }
      function updateFileList() {
        const fileListElement = document.getElementById("fileList");
        fileListElement.innerHTML = "";
        filesList.forEach((file, index) => {
          const fileElement = document.createElement("li");
          fileElement.classList.add("wrap");
          fileElement.innerHTML = `<h5>File: ${file.name}</h5>
          <div class="d-flex">
            <button onclick="removeFile(${index})"><span class="material-symbols-outlined">delete</span></button>
            <button onclick="uploadFile(${index})"><span class="material-symbols-outlined">upload</span></button>
          </div>
          <div id="uploadStatusContainer">
            <div id="uploadStatus${index}" class="upload-status"></div>
          </div>`;
          fileListElement.appendChild(fileElement);
        });
      }

      async function uploadFile(index) {
        const file = filesList[index];
        const formData = new FormData();
        formData.append("file", file);
        const xhr = new XMLHttpRequest(); // Create new XMLHttpRequest
        const uploadStatus = document.getElementById(`uploadStatus${index}`);

        // Update progress bar during the upload
        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percentComplete = event.loaded / event.total;
            uploadStatus.style.transform = `scaleX(${percentComplete})`; // Update the transform scale based on progress
          }
        };

        // Handle the response from server
        xhr.onload = function () {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            filePathList.push(data);
            getFiles();
            uploadStatus.style.transform = "scaleX(1)"; // Ensure the bar shows complete at the end
            uploadStatus.innerHTML = "Pronto!";
          } else {
            console.error("Error uploading file");
          }
        };

        xhr.onerror = function () {
          console.error("Error during file upload");
        };

        xhr.open("POST", `${API_URL}/upload`, true);
        xhr.send(formData);
      }

      async function uploadFiles() {
        fileList.forEach((file, index) => {
          uploadFile(index);
        });
      }

      function deleteFile(index) {
        const file = filePathList[index];
        fetch(`${API_URL}/delete?fileName=${file.fileName}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            filePathList.splice(index, 1);
            updateFilePathList();
          });
      }
    </script>
  </body>
</html>
